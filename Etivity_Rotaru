from sqlalchemy import create_engine, Column, Integer, String, Date, Text, ForeignKey, DECIMAL
from sqlalchemy.orm import declarative_base, relationship, sessionmaker
from datetime import date

Base = declarative_base()

# ========================
#        MODELLI ORM
# ========================

class Studente(Base):
    __tablename__ = "studente"

    ID_studente = Column(Integer, primary_key=True)
    nome = Column(String(50), nullable=False)
    cognome = Column(String(50), nullable=False)
    email = Column(String(100), unique=True, nullable=False)
    data_di_nascita = Column(Date, nullable=False)

    voti = relationship("Voto", back_populates="studente")
    assenze = relationship("Assenza", back_populates="studente")


class Docente(Base):
    __tablename__ = "docente"

    ID_docente = Column(Integer, primary_key=True)
    nome = Column(String(100), nullable=False)
    cognome = Column(String(100), nullable=False)
    email = Column(String(100), unique=True, nullable=False)

    voti = relationship("Voto", back_populates="docente")
    compiti = relationship("Compito", back_populates="docente")
    avvisi = relationship("Avviso", back_populates="docente")
    materie = relationship("Materia", back_populates="docente")


class Materia(Base):
    __tablename__ = "materia"

    ID_materia = Column(Integer, primary_key=True)
    nome_materia = Column(String(50), nullable=False)
    ID_docente = Column(Integer, ForeignKey('docente.ID_docente'))

    docente = relationship("Docente", back_populates="materie")
    voti = relationship("Voto", back_populates="materia")
    compiti = relationship("Compito", back_populates="materia")


class Voto(Base):
    __tablename__ = "voto"

    ID_voto = Column(Integer, primary_key=True)
    valore_numerico = Column(DECIMAL(5,2), nullable=False)
    data = Column(Date, nullable=False)
    commento = Column(Text)

    ID_studente = Column(Integer, ForeignKey('studente.ID_studente'))
    ID_docente = Column(Integer, ForeignKey('docente.ID_docente'))
    ID_materia = Column(Integer, ForeignKey('materia.ID_materia'))

    studente = relationship("Studente", back_populates="voti")
    docente = relationship("Docente", back_populates="voti")
    materia = relationship("Materia", back_populates="voti")


class Compito(Base):
    __tablename__ = "compito"

    ID_compito = Column(Integer, primary_key=True)
    descrizione = Column(Text, nullable=False)
    data_di_scadenza = Column(Date, nullable=False)

    ID_docente = Column(Integer, ForeignKey('docente.ID_docente'))
    ID_materia = Column(Integer, ForeignKey('materia.ID_materia'))

    docente = relationship("Docente", back_populates="compiti")
    materia = relationship("Materia", back_populates="compiti")


class Avviso(Base):
    __tablename__ = "avviso"

    ID_avviso = Column(Integer, primary_key=True)
    contenuto = Column(Text, nullable=False)
    data_pubblicazione = Column(Date, nullable=False)

    ID_docente = Column(Integer, ForeignKey('docente.ID_docente'))
    docente = relationship("Docente", back_populates="avvisi")


class Assenza(Base):
    __tablename__ = "assenza"

    ID_assenza = Column(Integer, primary_key=True)
    data = Column(Date, nullable=False)
    firma_digitale = Column(String(100))

    ID_studente = Column(Integer, ForeignKey('studente.ID_studente'))
    studente = relationship("Studente", back_populates="assenze")

def get_session():
    engine = create_engine("mysql+pymysql://root:auro2004@localhost:3306/SCUOLA", echo=True)
    Base.metadata.create_all(engine)
    Session = sessionmaker(bind=engine)
    return Session()


